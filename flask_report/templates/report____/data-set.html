{% extends "report____/layout.html" %}

{% block report____title_block %}
  {{ data_set.name }}
{% endblock %}

{% block report____customized_head_block %}
  <link rel="stylesheet" type="text/css" href="{{ url_for('report____.static', filename='datatables/css/jquery.dataTables.css') }}">
  <link rel="stylesheet" href="{{ url_for('report____.static', filename='css/customer.css') }}"/>
  <script type="text/javascript" charset="utf8" src="{{ url_for('report____.static', filename='datatables/js/jquery.dataTables.min.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('report____.static', filename='js/DT_bootstrap.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('report____.static', filename='js/jquery.autosize-min.js') }}"></script>
  <script type="text/javascript">
    $(function(){
    jQuery.fn.addFilter = function (col, text, available_opts, type, op, value) {
        var tr = $("<tr name='filter'></tr>");
        var td1 = $("<td></td>").html($("<button type='button' class='btn' name='remove-tr'></button>").html($("<i class='icon-remove icon-large'></i>")));
        var td2 = $("<td></td>").text(text);
        var select = $("<select></select>");
        $.each([
          {"key": "eq", "value": "等于"},
          {"key": "gt", "value": "大于"},
          {"key": "lt", "value": "小于"},
          {"key": "ge", "value": "大于等于"},
          {"key": "le", "value": "小于等于"},
          {"key": "ne", "value": "不等于"}
        ], function (idx, opt) {
          if (available_opts) {
            if ($.inArray(opt.key, available_opts) != -1) {
              select.append($("<option></option>").val(opt.key).text(opt.value));
            }
          } else {
            select.append($("<option></option>").val(opt.key).text(opt.value));
          }
        });
        if (op) {
          select.val(op);
        }
        var td3 = $("<td></td>").html(select);
        var input_str = "<input type='text' required></input>";

        var input = $(input_str);
        if (type) {
          if (type == "date") {
            input.datetimepicker({format: 'yyyy-mm-dd', minView: "month", autoclose: true, language: "{{ g.locale }}", pickerPosition: "bottom-left"});
          } else if (type == "datetime") {
            input.datetimepicker({format: 'yyyy-mm-dd hh:ii', autoclose: true, language: "{{ g.locale }}", minuteStep: 1, pickerPosition: "bottom-left"})
          } else {
            input_str = input_str.replace("text", type);
            input = $(input_str);
          }
        }

        if (value) {
          input.val(value)
        }
        input.attr("data-col", col);
        var td4 = $("<td></td>").html(input);
        tr.append(td1, td2, td3, td4);
        this.find("tbody").append(tr);
      };

      jQuery.fn.addOrderBy = function (text, op){
        var tr = $("<tr name='order_by'></tr>");
        var td1 = $("<td></td>").html($("<button type='button' class='btn' name='remove-tr'></button>").html($("<i class='icon-remove icon-large'></i>")));
        var td2 = $("<td></td>").text(text);
        var td3 = $("<td></td>");
        var select = $("<select></select>");
        $.each([{"key":"desc", "value": "desc"}, {"key": "asc", "value": "asc"}], function(idx, value){
          select.append($("<option></option>").val(value.value).text(value.key));
        });
        if(op){
          select.val(op);
        }
        td3.append(select);

        tr.append(td1, td2, td3);
        this.find("tbody").append(tr);
      };

      $("#add_filter").change(function () {
        var e = $($(this).find(":selected"));

        $("#clause").addFilter(e.val(), e.text(), $.parseJSON(e.attr("data-ops")), e.attr("data-type"));
        $(this).val([]);
      });

      $("#add_order_by").change(function(){
        if ($("tr[name=order_by]").size() > 0){
          alert('{{ _("only one order by columns supported") }}');
          return false;
        }
        var e = $($(this).find(":selected"));
        $("#order_by").addOrderBy(e.text());
        $(this).val([])
      });

      {% if current_filters %}
        $.each({{ current_filters|tojson|safe }}, function (idx, filter) {
          $("#clause").addFilter(filter.col, filter.name, filter.ops, filter.type, filter.op, filter.val);
        });
      {% endif %}

      {% if current_order_by %}
        $("#order_by").addOrderBy("{{ current_order_by[0]|safe }}", "{{ current_order_by[1]|safe }}");
      {% endif %}

      $("[name=remove-tr]").live("click", function () {
        $(this).closest("tr").remove();
      });

      $("#search").click(function () {
        var form = $(this).parents("form");
        if (form.get(0).checkValidity()) {
          var filters = [];
          $.each(form.find("tr[name='filter']"), function (idx, tr) {
            var input=$($(tr).find("input")[0]);
            filters.push({"col": input.attr("data-col"), "op": $($(tr).find("select")).val(), "val": input.val()});
          });
          var tr = form.find("tr[name=order_by]");
          var order_bys = $($(tr).find("td")[1]).text();
          if ($($(tr).find("select")).val() == "desc"){
            order_bys = "-" + order_bys;
          }
          form.find("input[type=hidden][name=filters]").val(JSON.stringify(filters));
          form.find("input[type=hidden][name=order_bys]").val(order_bys);
          form.submit();
        }
      });
      $("textarea").autosize();
    })
  </script>
{% endblock %}

{% block body %}
  <div>
    <div class="alert alert-info">
      <h1>
        {{ data_set.name }}
      </h1>
    </div>
    <form action="{{ url_for(".data_set", id_=data_set.id_) }}" method="GET">
      <fieldset>
        <legend>{{ _("filters") }}</legend>
        <table id="clause">
          <tbody>
          <tr>
            <td colspan="2">
              <label for="add_filter">新增</label>
              <select id="add_filter">
                <option></option>
                {% for filter in data_set.filters %}
                  <option value="{{ filter.col }}" data-type="{{ filter.type }}" data-ops='{{ filter.ops|tojson|safe }}'>{{ filter.name }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          </tbody>
        </table>
      </fieldset>
      {% if data_set.order_bys %}
      <fieldset>
        <legend>{{ _("order by") }}</legend>
        <table id="order_by">
          <tbody>
          <tr>
            <td colspan="2">
              <label for="add_order_by">新增</label>
              <select id="add_order_by">
                <option></option>
                {% for order_by in data_set.order_bys %}
                  <option value="{{ order_by }}">{{ order_by }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          </tbody>
        </table>
      </fieldset>
      {% endif %}
      <input type="hidden" name="filters"/>
      <input type="hidden" name="order_bys"/>
      <div class="control-group">
        <div class="controls">
          <button class="btn btn-primary" id="search"><i class="icon-search"></i>&nbsp;{{ _("Search") }}</button>
        </div>
      </div>
    </form>

    <legend>{{ _("RESULT") }}</legend>
    {% if filters_yaml %}
      <div>
        <h4>{{ _("Filters") }}</h4>
        <code>
          filters: {{ filters_yaml }}
        </code>
      </div>
    {% endif %}
    {% if order_by_yaml %}
      <div>
        <h4>{{ _("Orders") }}</h4>
        <code>
          order_by: {{ order_by_yaml }}
        </code>
      </div>
    {% endif %}
    {% if SQL %}
      <div>
        <h4>{{ _("SQL") }}</h4>
        {{ SQL|safe }}
      </div>
    {% endif %}

    <div class="pagination-centered span12">
      <a href="{{ url_for('.data_set_list') }}" class="btn btn-primary btn-large">{{ _('BACK') }}</a>
      <button type="button" data-toggle="modal" data-target="#saveModal" class="btn btn-primary btn-large">{{ _("SAVE") }}</button>
      <a href="{{ url_for('.report', id_=0, url=request.url) }}" class="btn btn-primary btn-large">{{ _('VIEW RESULTS') }}</a>
    </div>
  </div>
  <div class="modal hide fade" id="saveModal" tabindex="-1">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3>保存</h3>
    </div>
    <form action="{{ url_for(".report") }}" method="POST">
      <div class="modal-body ">
        <fieldset class="form-horizontal">
          <div class="control-group">
            <label for="report_name" class="control-label">{{ _("Report name") }}</label>

            <div class="controls">
              <input type="text" name="name" required="required" id="report_name"/>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="report_creator">{{ _("Report creator") }}</label>

            <div class="controls">
              <input type="text" name="creator" id="report_creator"/>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="report_desc">{{ _("Report desc") }}</label>

            <div class="controls">
              <textarea name="description" id="report_desc"></textarea>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label">{{ _("Report filters") }}</label>

            <div class="controls">
              <textarea name="filters" readonly>{{ filters_yaml }}</textarea>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="report_order_by">{{ _("order by") }}</label>

            <div class="controls">
              <input type="text" name="order_by" id="report_order_by" value="{{ order_by_yaml }}" readonly/>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="report_columns">{{ _("columns") }}</label>

            <div class="controls">
              <select name="columns" id="report_columns" multiple>
                {% for c in data_set.columns %}
                  <option value="{{ c.idx }}" selected>{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <input type="hidden" name="url" value="{{ request.url }}"/>
          <input type="hidden" name="data_set_id" value="{{ data_set.id_ }}"/>
        </fieldset>
      </div>
      <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <button class="btn btn-primary">{{ _("SAVE REPORT") }}</button>
      </div>
    </form>
  </div>
{% endblock %}
